<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Order Matcher - Pro Edition</title>
    <style>
        body { font-family: -apple-system, sans-serif; padding: 20px; background: #f0f2f5; color: #333; max-width: 1400px; margin: 0 auto; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 20px; }
        textarea { width: 100%; height: 300px; padding: 10px; border-radius: 8px; border: 1px solid #ccc; box-sizing: border-box; }
        input[type="text"], input[type="file"] { width: 100%; padding: 12px; margin: 10px 0; border-radius: 8px; border: 1px solid #ccc; box-sizing: border-box; }
       
        .tag { font-size: 10px; padding: 2px 6px; border-radius: 4px; font-weight: bold; text-transform: uppercase; }
        .tag-cust { background: #e8f5e9; color: #2e7d32; border: 1px solid #a5d6a7; }
        .tag-master { background: #e3f2fd; color: #1565c0; border: 1px solid #90caf9; }

        .autocomplete-container { position: relative; }
        #suggestionsList, #modalSearchList {
            position: absolute; background: white; border: 1px solid #ccc; z-index: 3000;
            max-height: 250px; overflow-y: auto; display: none; width: 100%;
            border-radius: 0 0 8px 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .suggestion-item { padding: 12px; cursor: pointer; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .suggestion-item:hover { background: #f0f7ff; }

        #modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); }
        .modal-content { background: white; margin: 5% auto; padding: 25px; width: 550px; border-radius: 12px; position: relative; }
        .qty-row { display: flex; gap: 10px; background: #fff5f5; padding: 15px; border-radius: 8px; border: 1px solid #ffdada; margin-bottom: 15px; }
       
        button { cursor: pointer; font-weight: bold; border-radius: 8px; border: none; }
        .main-btn { background: #d32f2f; color: white; padding: 15px; width: 100%; font-size: 16px; margin-bottom: 10px; }
        .clear-btn { background: #666; color: white; padding: 10px; width: 100%; font-size: 14px; }
        .opt { padding: 12px; border: 1px solid #eee; margin: 5px 0; cursor: pointer; border-radius: 6px; display: flex; justify-content: space-between; font-size: 14px; background: #fafafa;}
       
        .output-box { background: white; padding: 20px; border: 2px solid #d32f2f; border-radius: 8px; min-height: 300px; white-space: pre-wrap; font-size: 14px; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 13px; }
        th { background: #333; color: white; padding: 10px; text-align: left; }
        td { border-bottom: 1px solid #ddd; padding: 8px; }
    </style>
</head>
<body>

<div id="modal">
    <div class="modal-content">
        <h3>Verify Product Match</h3>
        <p id="modalDesc" style="font-size: 13px; color: #666; margin-bottom: 10px;"></p>
        <div class="qty-row">
            <div style="flex:2">
                <label style="font-size: 10px; font-weight: bold;">QUANTITY</label>
                <input type="text" id="modalQtyInput" style="width:100%; font-size:18px; border:2px solid #d32f2f; padding:5px; box-sizing:border-box;">
            </div>
            <div style="flex:1">
                <label style="font-size: 10px; font-weight: bold;">UNIT</label>
                <select id="modalUnitInput" style="width:100%; padding:8px;">
                    <option value="">(None)</option>
                    <option value="KG">KG</option>
                    <option value="SM">SM</option>
                    <option value="Units">Units</option>
                    <option value="PKT">PKT</option>
                </select>
            </div>
        </div>
        <label style="font-size: 12px; font-weight: bold;">MANUAL SEARCH:</label>
        <div class="autocomplete-container">
            <input type="text" id="modalSearchInput" placeholder="Try typing 'pep'..." autocomplete="off">
            <div id="modalSearchList"></div>
        </div>
        <p style="font-size: 11px; font-weight: bold; margin-top: 15px; color: #2e7d32;">SUGGESTIONS:</p>
        <div id="options" style="margin-top: 5px;"></div>
        <div style="display:flex; gap: 10px; margin-top: 20px;">
            <button onclick="keepOriginal()" style="flex:1; padding:10px; background:#eee;">Keep As Text</button>
            <button onclick="ignoreLine()" style="flex:1; padding:10px; background:#eee;">Ignore Line</button>
        </div>
    </div>
</div>

<div class="grid">
    <div class="card">
        <h2>1. Setup</h2>
        <input type="file" id="csvFile">
        <div class="autocomplete-container">
            <input type="text" id="customerInput" placeholder="Customer Name..." autocomplete="off">
            <div id="suggestionsList"></div>
        </div>
        <h2>2. Order</h2>
        <textarea id="orderInput" placeholder="Paste order here..."></textarea>
        <button class="main-btn" onclick="processOrder()">PROCESS EVERYTHING</button>
        <button class="clear-btn" onclick="clearAll()">CLEAR ALL DATA</button>
    </div>

    <div>
        <div class="card">
            <h2>3. Clean Output (ClickUp)</h2>
            <div id="output" class="output-box"></div>
            <button onclick="copyText('output')" style="width: 100%; margin-top: 10px; padding: 10px; background: #d32f2f; color:white;">Copy List</button>
        </div>
        <div class="card">
            <h2>4. Invoice Details</h2>
            <table>
                <thead><tr><th>SKU</th><th>Product</th><th>Qty</th><th>Price</th></tr></thead>
                <tbody id="invoiceBody"></tbody>
            </table>
        </div>
    </div>
</div>

<script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
<script>
    let masterDb = [];
    let uniqueCustomers = [];
    let currentQueue = [];
    let clickUpResults = [];
    let invoiceData = [];

    document.getElementById('csvFile').addEventListener('change', (e) => {
        const reader = new FileReader();
        reader.onload = (event) => {
            const wb = XLSX.read(event.target.result, {type: 'binary'});
            masterDb = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
            let custSet = new Set();
            masterDb.forEach(row => {
                let c = row.Customer || row.customer;
                if (c && !isMaster(c)) custSet.add(c.trim());
            });
            uniqueCustomers = Array.from(custSet).sort();
            alert("Database Ready");
        };
        reader.readAsBinaryString(e.target.files[0]);
    });

    function isMaster(name) {
        if (!name) return true;
        const n = name.toLowerCase().trim();
        return ["master", "stock", "general", ""].includes(n);
    }

    function getPriority(item, targetCust) {
        const cust = (item.Customer || item.customer || "").toLowerCase().trim();
        if (cust === targetCust.toLowerCase().trim()) return 1;
        if (isMaster(cust)) return 2;
        return 3;
    }

    // New, more robust search logic
    function searchMasterList(query, targetCust) {
        if (!query) return [];
        // Removes extra spaces and splits by space
        const terms = query.toLowerCase().trim().split(/\s+/).filter(t => t.length > 0);
        if (terms.length === 0) return [];

        return masterDb.filter(item => {
            const prodName = (item.Product || item.product || "").toLowerCase();
            // All terms must be found in the product name
            return terms.every(term => prodName.includes(term));
        }).sort((a, b) => getPriority(a, targetCust) - getPriority(b, targetCust)).slice(0, 20);
    }

    function getSim(s1, s2) {
        if (!s1 || !s2) return 0;
        let l = s1.length > s2.length ? s1 : s2, s = s1.length > s2.length ? s2 : s1;
        let costs = [];
        for (let i = 0; i <= s1.length; i++) {
            let last = i;
            for (let j = 0; j <= s2.length; j++) {
                if (i == 0) costs[j] = j;
                else if (j > 0) {
                    let nv = costs[j - 1];
                    if (s1[i - 1] != s2[j - 1]) nv = Math.min(Math.min(nv, last), costs[j]) + 1;
                    costs[j - 1] = last; last = nv;
                }
            }
            if (i > 0) costs[s2.length] = last;
        }
        return (l.length - costs[s2.length]) / l.length;
    }

    // Customer Autocomplete
    const custInput = document.getElementById('customerInput');
    const suggs = document.getElementById('suggestionsList');
    custInput.addEventListener('input', () => {
        const val = custInput.value.toLowerCase();
        suggs.innerHTML = '';
        if (!val) { suggs.style.display = 'none'; return; }
        uniqueCustomers.filter(c => c.toLowerCase().includes(val)).slice(0, 8).forEach(m => {
            const d = document.createElement('div'); d.className = 'suggestion-item'; d.innerText = m;
            d.onclick = () => { custInput.value = m; suggs.style.display = 'none'; };
            suggs.appendChild(d);
        });
        suggs.style.display = 'block';
    });

    // Modal Search Listener (Improved to handle 'pep')
    const mSearchInput = document.getElementById('modalSearchInput');
    const mSearchList = document.getElementById('modalSearchList');
    mSearchInput.addEventListener('input', () => {
        const val = mSearchInput.value;
        const targetCust = custInput.value;
        mSearchList.innerHTML = '';
        if (val.trim().length < 1) { mSearchList.style.display = 'none'; return; }
       
        const filtered = searchMasterList(val, targetCust);
        filtered.forEach(item => {
            const prio = getPriority(item, targetCust);
            const d = document.createElement('div');
            d.className = 'suggestion-item';
            d.innerHTML = `<span>${item.Product || item.product}</span>
                           <span class="tag ${prio === 1 ? 'tag-cust' : 'tag-master'}">${prio === 1 ? 'CUST' : 'MASTER'}</span>`;
            d.onclick = () => selectFromModal(item);
            mSearchList.appendChild(d);
        });
        mSearchList.style.display = 'block';
    });

    function processOrder() {
        const text = document.getElementById('orderInput').value;
        const targetCust = custInput.value.toLowerCase().trim();
        let rawLines = text.split(/\n|,|;|&|\band\b/i);
        currentQueue = [];
        clickUpResults = [`ORDER FOR: ${custInput.value}\n`];
        invoiceData = [];

        rawLines.forEach(line => {
            let cleanLine = line.trim();
            if (cleanLine.length < 2) return;
            let qM = cleanLine.match(/(\d+(?:\.\d+)?)/);
            let qty = qM ? qM[0] : "1";
            let unitMatch = cleanLine.match(/(kg|sm|units?|pkt)/i);
            let unit = unitMatch ? unitMatch[0] : "";
            let name = cleanLine.replace(qty, '').replace(/x|kg|pkt|unit|sm/gi, '').trim();

            let candidates = searchMasterList(name, targetCust);
            let best = candidates[0];
            let simScore = best ? getSim(name.toLowerCase(), (best.Product || "").toLowerCase()) : 0;

            if (best && simScore > 0.92 && getPriority(best, targetCust) < 3) {
                addFinalResult(qty, unit, best);
            } else {
                currentQueue.push({ line: cleanLine, qty, name, unit, suggestions: candidates.slice(0, 5) });
            }
        });
        renderOutputs();
        runQueue();
    }

    function addFinalResult(qty, unit, item) {
        let qStr = `${qty}${unit ? ' ' + unit : ''}`;
        clickUpResults.push(`${qStr} x ${item.Product || item.product}`);
       
        let priceVal = item.Price || item.price;
        let priceDisplay = (priceVal && priceVal != 0) ? priceVal : "Xero Price";
       
        invoiceData.push({
            sku: item.SKU || "N/A",
            name: item.Product || item.product,
            qty: qStr,
            price: priceDisplay
        });
    }

    function renderOutputs() {
        document.getElementById('output').innerText = clickUpResults.join('\n');
        const body = document.getElementById('invoiceBody');
        body.innerHTML = '';
        invoiceData.forEach(row => {
            let tr = body.insertRow();
            tr.insertCell(0).innerText = row.sku;
            tr.insertCell(1).innerText = row.name;
            tr.insertCell(2).innerText = row.qty;
            tr.insertCell(3).innerText = row.price;
        });
    }

    function runQueue() {
        if (currentQueue.length === 0) { renderOutputs(); return; }
        let item = currentQueue[0];
        document.getElementById('modal').style.display = 'block';
        document.getElementById('modalDesc').innerText = `Matching: "${item.line}"`;
        document.getElementById('modalQtyInput').value = item.qty;
        document.getElementById('modalUnitInput').value = item.unit.toUpperCase() || "";
        document.getElementById('modalSearchInput').value = item.name;
       
        let cont = document.getElementById('options'); cont.innerHTML = '';
        item.suggestions.forEach(s => {
            const prio = getPriority(s, custInput.value);
            let d = document.createElement('div'); d.className = 'opt';
            d.innerHTML = `<span>${s.Product}</span> <span class="tag ${prio === 1 ? 'tag-cust' : 'tag-master'}">${prio === 1 ? 'CUST' : 'MASTER'}</span>`;
            d.onclick = () => selectFromModal(s);
            cont.appendChild(d);
        });
    }

    function selectFromModal(item) {
        currentQueue.shift();
        addFinalResult(document.getElementById('modalQtyInput').value, document.getElementById('modalUnitInput').value, item);
        mSearchList.style.display = 'none';
        document.getElementById('modal').style.display = 'none';
        runQueue();
    }

    function keepOriginal() {
        let q = currentQueue.shift();
        let qStr = `${document.getElementById('modalQtyInput').value} ${document.getElementById('modalUnitInput').value}`;
        clickUpResults.push(`CHECK: ${qStr} x ${q.name}`);
        invoiceData.push({ sku: "???", name: q.name, qty: qStr, price: "Xero Price" });
        document.getElementById('modal').style.display = 'none';
        runQueue();
    }
   
    function ignoreLine() { currentQueue.shift(); document.getElementById('modal').style.display = 'none'; runQueue(); }
   
    function clearAll() {
        if(confirm("Clear all work?")) {
            document.getElementById('orderInput').value = '';
            document.getElementById('output').innerText = '';
            document.getElementById('invoiceBody').innerHTML = '';
            clickUpResults = [];
            invoiceData = [];
        }
    }

    function copyText(id) { navigator.clipboard.writeText(document.getElementById(id).innerText); alert("Copied!"); }
</script>
</body>
</html>
